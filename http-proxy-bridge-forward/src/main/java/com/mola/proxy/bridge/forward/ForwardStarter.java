package com.mola.proxy.bridge.forward;

import com.mola.proxy.bridge.core.enums.ServerTypeEnum;
import com.mola.proxy.bridge.core.ext.ExtManager;
import com.mola.proxy.bridge.forward.ext.Socks5AuthExtImpl;
import com.mola.proxy.bridge.core.server.forward.ForwardProxyServer;
import com.mola.proxy.bridge.core.utils.ConfigQueryUtil;
import com.mola.proxy.bridge.core.utils.LogUtil;

import java.util.Locale;
import java.util.Map;

public class ForwardStarter {

    public static void main(String[] args) {
        LogUtil.debugReject();

        UserIpWhiteListExtImpl userIpWhiteListExt = new UserIpWhiteListExtImpl();
        ExtManager.setUserIpWhiteListExt(userIpWhiteListExt);
        userIpWhiteListExt.start();
        ExtManager.setSocks5AuthExt(new Socks5AuthExtImpl());

        // 启动加密服务
        new Thread(() -> {
            ForwardProxyServer encryptionProxyServer = new ForwardProxyServer();
            encryptionProxyServer.start(20434, 10434, ServerTypeEnum.SSL_HTTP);
        }).start();

        // 启动ssl纯转发代理
        new Thread(() -> {
            ForwardProxyServer encryptionProxyServer = new ForwardProxyServer();
            encryptionProxyServer.start(20435, 10433, ServerTypeEnum.SSL_TRANSFER);
        }).start();

        // 启动普通http代理
        Map<String, String> config = ConfigQueryUtil.getConfig(args);
        int port = Integer.parseInt(config.getOrDefault("port", "20432"));
        int reversePort = Integer.parseInt(config.getOrDefault("reversePort", "10433"));
        ServerTypeEnum serverTypeEnum = ServerTypeEnum.valueOf(config.getOrDefault("type", "HTTP").toUpperCase(Locale.ROOT));
        ForwardProxyServer forwardProxyServer = new ForwardProxyServer();
        forwardProxyServer.start(port, reversePort, serverTypeEnum);
    }
}